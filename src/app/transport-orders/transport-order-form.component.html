<!-- src/app/transport-orders/transport-order-form.component.html -->
<div class="transport-order-container">
  <h1>Zamówienie transportu roweru</h1>
  
  <!-- Loading State -->
  <div *ngIf="loading" class="loading-message">
    <div class="loading-spinner"></div>
    <p>Ładowanie danych...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="error-message">
    {{ error }}
  </div>

  <!-- Steps Progress -->
  <div class="steps-container">
    <div class="step completed">
      <div class="step-number">1</div>
      <div class="step-label">Dane rowerów</div>
    </div>
    <div class="step-connector"></div>
    <div class="step active">
      <div class="step-number">2</div>
      <div class="step-label">Dane kontaktowe</div>
    </div>
    <div class="step-connector"></div>
    <div class="step active">
      <div class="step-number">3</div>
      <div class="step-label">Szczegóły transportu</div>
    </div>
    <div class="step-connector"></div>
    <div class="step active">
      <div class="step-number">4</div>
      <div class="step-label">Podsumowanie</div>
    </div>
  </div>

  <!-- Main Form -->
  <div *ngIf="!loading && !error" class="step-content">
    <!-- Service Info Card -->
    <div class="service-info-card" *ngIf="selectedServiceInfo.name">
      <h3>Serwis docelowy</h3>
      <div class="service-details">
        <div class="service-name">{{ selectedServiceInfo.name }}</div>
        <div class="service-address">📍 {{ selectedServiceInfo.address }}</div>
      </div>
    </div>

    <form [formGroup]="transportForm" (ngSubmit)="onSubmit()">
      
      <!-- SEKCJA 1: Bicycle Information -->
      <div class="form-section">
        <h2>Dane rowerów do transportu</h2>
        <p class="section-description">
          Dodaj informacje o rowerach, które mają zostać przewiezione do serwisu.
        </p>

        <div formArrayName="bicycles">
          <div 
            *ngFor="let bicycleControl of bicyclesArray.controls; let i = index" 
            [formGroupName]="i" 
            class="bicycle-form-card"
          >
            <div class="bicycle-card-header">
              <h4>Rower {{ i + 1 }}</h4>
              <button 
                type="button" 
                class="remove-bicycle-btn" 
                (click)="removeBicycleFromForm(i)"
                *ngIf="bicyclesArray.length > 1"
                title="Usuń rower"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
              </button>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label [for]="'brand-' + i">Marka roweru *</label>
                <input 
                  type="text" 
                  [id]="'brand-' + i"
                  formControlName="brand"
                  [class.is-invalid]="bicycleControl.get('brand')?.invalid && bicycleControl.get('brand')?.touched"
                  placeholder="np. Giant, Trek, Specialized"
                >
                <div *ngIf="bicycleControl.get('brand')?.invalid && bicycleControl.get('brand')?.touched" class="error-message">
                  Marka roweru jest wymagana (min. 2 znaki)
                </div>
              </div>

              <div class="form-group">
                <label [for]="'model-' + i">Model roweru *</label>
                <input 
                  type="text" 
                  [id]="'model-' + i"
                  formControlName="model"
                  [class.is-invalid]="bicycleControl.get('model')?.invalid && bicycleControl.get('model')?.touched"
                  placeholder="np. Talon, Marlin, Rockhopper"
                >
                <div *ngIf="bicycleControl.get('model')?.invalid && bicycleControl.get('model')?.touched" class="error-message">
                  Model roweru jest wymagany (min. 2 znaki)
                </div>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label [for]="'type-' + i">Typ roweru *</label>
                <select 
                  [id]="'type-' + i"
                  formControlName="type"
                  [class.is-invalid]="bicycleControl.get('type')?.invalid && bicycleControl.get('type')?.touched"
                >
                  <option value="">-- Wybierz typ --</option>
                  <option *ngFor="let type of getBicycleTypes()" [value]="type">{{ type }}</option>
                </select>
                <div *ngIf="bicycleControl.get('type')?.invalid && bicycleControl.get('type')?.touched" class="error-message">
                  Typ roweru jest wymagany
                </div>
              </div>

              <div class="form-group">
                <label [for]="'frameMaterial-' + i">Materiał ramy</label>
                <select 
                  [id]="'frameMaterial-' + i"
                  formControlName="frameMaterial"
                >
                  <option value="">-- Wybierz materiał --</option>
                  <option *ngFor="let material of getFrameMaterials()" [value]="material">{{ material }}</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label [for]="'description-' + i">Dodatkowe informacje o rowerze</label>
              <textarea 
                [id]="'description-' + i"
                formControlName="description"
                rows="3"
                placeholder="Dodatkowe informacje o rowerze, usterki, specjalne wymagania..."
              ></textarea>
            </div>
          </div>
        </div>

        <button type="button" class="add-bicycle-btn" (click)="addBicycleToForm()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          Dodaj kolejny rower
        </button>

        <!-- Selection Summary -->
        <div class="selection-summary" *ngIf="getSelectedBicyclesCount() > 0">
          <h4>Podsumowanie wyboru:</h4>
          <div class="summary-item">
            Liczba rowerów: <strong>{{ getSelectedBicyclesCount() }}</strong>
          </div>
          <div class="summary-item">
            Szacowany koszt transportu: <strong>{{ getEstimatedTransportCost() }} zł</strong>
          </div>
        </div>
      </div>

      <!-- SEKCJA 2: Client Information -->
      <div class="form-section">
        <h2>Dane kontaktowe</h2>
        <p class="section-description">
          Podaj swoje dane kontaktowe potrzebne do realizacji transportu.
        </p>

        <div class="form-row">
          <div class="form-group">
            <label for="clientEmail">Adres email *</label>
            <input 
              type="email" 
              id="clientEmail" 
              formControlName="clientEmail"
              [class.is-invalid]="isFieldInvalid('clientEmail')"
              placeholder="jan.kowalski@example.com"
            >
            <div *ngIf="isFieldInvalid('clientEmail')" class="error-message">
              Wprowadź poprawny adres email
            </div>
          </div>
          
          <div class="form-group">
            <label for="clientPhone">Numer telefonu *</label>
            <input 
              type="tel" 
              id="clientPhone" 
              formControlName="clientPhone"
              [class.is-invalid]="isFieldInvalid('clientPhone')"
              placeholder="123456789"
              maxlength="9"
            >
            <div *ngIf="isFieldInvalid('clientPhone')" class="error-message">
              Wprowadź poprawny numer telefonu (9 cyfr)
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label for="clientName">Imię i nazwisko *</label>
          <input 
            type="text" 
            id="clientName" 
            formControlName="clientName"
            [class.is-invalid]="isFieldInvalid('clientName')"
            placeholder="Jan Kowalski"
          >
          <div *ngIf="isFieldInvalid('clientName')" class="error-message">
            Imię i nazwisko jest wymagane (min. 2 znaki)
          </div>
        </div>
      </div>

      <!-- SEKCJA 3: Pickup Details -->
      <div class="form-section">
        <h2>Szczegóły odbioru</h2>
        <p class="section-description">
          Określ kiedy i skąd mamy odebrać Twoje rowery.
        </p>

        <div class="form-group">
          <label for="pickupDate">Data odbioru *</label>
          <div class="date-info">
            Odbiór roweru dostępny od niedzieli do czwartku w godzinach 18:00-22:00.
          </div>
          <input 
            type="date" 
            id="pickupDate" 
            formControlName="pickupDate"
            [class.is-invalid]="isFieldInvalid('pickupDate')"
            [min]="minDate"
            [max]="maxDate"
          >
          <div *ngIf="isFieldInvalid('pickupDate')" class="error-message">
            <span *ngIf="transportForm.get('pickupDate')?.hasError('required')">Wybierz datę odbioru</span>
            <span *ngIf="transportForm.get('pickupDate')?.hasError('invalidDay')">Odbiór możliwy tylko od niedzieli do czwartku</span>
          </div>
        </div>
        
        <div class="form-group">
          <label for="pickupAddress">Adres odbioru *</label>
          <input 
            type="text" 
            id="pickupAddress" 
            formControlName="pickupAddress"
            [class.is-invalid]="isFieldInvalid('pickupAddress')"
            placeholder="ul. Przykładowa 123/45, 31-000 Kraków"
          >
          <div *ngIf="isFieldInvalid('pickupAddress')" class="error-message">
            Adres jest wymagany (min. 5 znaków)
          </div>
          <div class="help-text">
            Podaj pełny adres z numerem mieszkania (jeśli dotyczy)
          </div>
        </div>
        
        <div class="form-group">
          <label for="additionalNotes">Dodatkowe informacje</label>
          <textarea 
            id="additionalNotes" 
            formControlName="additionalNotes"
            rows="4"
            placeholder="Informacje o preferowanych godzinach odbioru, dodatkowe wskazówki dla kuriera, kod do bramy, piętro, itp."
          ></textarea>
          <div class="help-text">
            Opcjonalne: Podaj wszelkie informacje, które ułatwią kuriemu odbiór rowerów
          </div>
        </div>
      </div>

      <!-- SEKCJA 4: Order Summary -->
      <div class="order-summary" *ngIf="getSelectedBicyclesCount() > 0">
        <h3>Podsumowanie zamówienia transportu</h3>
        
        <div class="summary-details">
          <!-- Rowery -->
          <div class="summary-row">
            <span>Liczba rowerów:</span>
            <span><strong>{{ getSelectedBicyclesCount() }}</strong></span>
          </div>
          
          <!-- Lista rowerów -->
          <div class="summary-section" *ngIf="getBicyclesData().length > 0">
            <h4>Lista rowerów:</h4>
            <div class="summary-bikes">
              <div *ngFor="let bicycleData of getBicyclesData(); let i = index" class="summary-bike">
                <span class="bike-index">{{ i + 1 }}.</span>
                <span class="bike-name">{{ bicycleData.brand }} {{ bicycleData.model || '' }} ({{ bicycleData.type }})</span>
              </div>
            </div>
          </div>
          
          <!-- Kontakt -->
          <div class="summary-row" *ngIf="transportForm.get('clientName')?.value">
            <span>Kontakt:</span>
            <span>{{ transportForm.get('clientName')?.value }}</span>
          </div>
          
          <div class="summary-row" *ngIf="transportForm.get('clientEmail')?.value">
            <span>Email:</span>
            <span>{{ transportForm.get('clientEmail')?.value }}</span>
          </div>
          
          <div class="summary-row" *ngIf="transportForm.get('clientPhone')?.value">
            <span>Telefon:</span>
            <span>{{ transportForm.get('clientPhone')?.value }}</span>
          </div>
          
          <!-- Transport -->
          <div class="summary-row" *ngIf="transportForm.get('pickupDate')?.value">
            <span>Data odbioru:</span>
            <span>{{ transportForm.get('pickupDate')?.value | date:'dd.MM.yyyy' }}</span>
          </div>
          
          <div class="summary-row" *ngIf="transportForm.get('pickupAddress')?.value">
            <span>Adres odbioru:</span>
            <span>{{ transportForm.get('pickupAddress')?.value }}</span>
          </div>
          
          <div class="summary-row" *ngIf="selectedServiceInfo.name">
            <span>Serwis docelowy:</span>
            <span>{{ selectedServiceInfo.name }}</span>
          </div>
          
          <div class="summary-row" *ngIf="selectedServiceInfo.address">
            <span>Adres serwisu:</span>
            <span>{{ selectedServiceInfo.address }}</span>
          </div>
          
          <!-- Koszt -->
          <div class="summary-row total">
            <span>Całkowity koszt transportu:</span>
            <span class="price">{{ getEstimatedTransportCost() }} zł</span>
          </div>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <button type="button" class="cancel-btn" (click)="goBack()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m15 18-6-6 6-6"/>
          </svg>
          Wróć
        </button>
        
        <button 
          type="submit" 
          class="submit-btn" 
          [disabled]="transportForm.invalid || submitting || getSelectedBicyclesCount() === 0"
        >
          <svg *ngIf="!submitting" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M5 12h14"/>
            <path d="m12 5 7 7-7 7"/>
          </svg>
          <span *ngIf="submitting" class="loading-spinner"></span>
          {{ submitting ? 'Przetwarzanie...' : 'Zamów transport' }}
        </button>
      </div>
    </form>
  </div>
</div>